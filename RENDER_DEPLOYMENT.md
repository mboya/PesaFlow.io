# Render Deployment Guide

This guide explains how to deploy PesaFlow.io to Render using Docker.

## Deployment Options

### Option 1: Combined Deployment (Recommended for Simplicity)

Deploy both backend and frontend together in a single service. This is simpler and more cost-effective.

**File:** Use `render-combined.yaml`

**Benefits:**
- Single service to manage
- Lower cost (one web service instead of two)
- Simpler configuration
- Both services deploy together automatically

**Trade-offs:**
- Cannot scale backend and frontend independently
- Requires more resources (standard plan recommended)

### Option 2: Separate Deployment

Deploy backend and frontend as separate services for independent scaling.

**File:** Use `render.yaml`

**Benefits:**
- Can scale backend and frontend independently
- Better resource isolation
- More flexible for high-traffic scenarios

**Trade-offs:**
- Higher cost (two web services)
- More complex configuration
- Need to manage service dependencies

## Quick Start

### Using Render Blueprint (Recommended)

1. **Push your code to GitHub/GitLab/Bitbucket**

2. **Connect your repository to Render:**
   - Go to Render Dashboard
   - Click "New +" → "Blueprint"
   - Connect your repository
   - Choose your deployment file:
     - `render-combined.yaml` for combined deployment
     - `render.yaml` for separate deployment
   - Render will automatically create all services

3. **Configure Environment Variables:**
   - Go to the service's "Environment" tab
   - Set the required environment variables (see below)

### Manual Setup

See the detailed sections below for manual setup instructions.

## Environment Variables

### Combined Deployment (`render-combined.yaml`)

#### Main App Service (`pesaflow-app`):

**Required Rails Variables:**
- `RAILS_ENV`: `production`
- `RAILS_MASTER_KEY`: Copy from `backend/config/master.key` (or generate new one)
- `SECRET_KEY_BASE`: Auto-generated by Render (or set manually)
- `DATABASE_URL`: Auto-connected from PostgreSQL service
- `REDIS_URL`: Auto-connected from Redis service

**M-Pesa Configuration:**
- `MPESA_BASE_URL`: `https://api.safaricom.co.ke` (production) or `https://sandbox.safaricom.co.ke` (sandbox)
- `MPESA_CONSUMER_KEY`: Your M-Pesa Consumer Key
- `MPESA_CONSUMER_SECRET`: Your M-Pesa Consumer Secret
- `MPESA_BUSINESS_SHORT_CODE`: Your business short code
- `MPESA_PASSKEY`: Your M-Pesa passkey
- `MPESA_CALLBACK_URL`: `https://your-app-url.onrender.com/webhooks/stk_push/callback`
- `APP_HOST`: Your app URL (e.g., `pesaflow-app.onrender.com`)

**SMTP Configuration:**
- `SMTP_HOST`: Your SMTP server (e.g., `smtp.sendgrid.net`, `smtp.mailgun.org`)
- `SMTP_PORT`: `587` (or `465` for SSL)
- `SMTP_USERNAME`: Your SMTP username
- `SMTP_PASSWORD`: Your SMTP password
- `SMTP_FROM_EMAIL`: Email address to send from (e.g., `noreply@yourdomain.com`)

**Frontend Configuration (Auto-set):**
- `NEXT_PUBLIC_API_URL`: Auto-set to `https://your-app-url.onrender.com/api/proxy`
- `BACKEND_INTERNAL_URL`: Auto-set to `http://localhost:3000` (internal)
- `NEXT_PUBLIC_WS_URL`: Auto-set to `wss://your-app-url.onrender.com/api/proxy/ws`
- `FRONTEND_URL`: Auto-set for CORS

### Separate Deployment (`render.yaml`)

See the original `RENDER_DEPLOYMENT.md` for separate deployment environment variables.

## Post-Deployment Steps

### 1. Run Database Migrations

After the service is deployed:

```bash
# Using Render Shell
render shell pesaflow-app  # or pesaflow-backend for separate deployment

# Inside the shell
cd /rails
bundle exec rails db:migrate
bundle exec rails db:seed
```

### 2. Verify Services

1. **Backend Health Check:**
   - Visit: `https://your-app-url.onrender.com/up`
   - Should return: `{"status":"ok"}`

2. **Frontend:**
   - Visit: `https://your-app-url.onrender.com`
   - Should show the landing page

3. **Database Connection:**
   - Check service logs for any database connection errors

### 3. Configure Custom Domain (Optional)

1. In Render dashboard, go to your service
2. Click "Custom Domains"
3. Add your domain
4. Update DNS records as instructed
5. Update `APP_HOST` and callback URLs with your custom domain

## Service Architecture

### Combined Deployment

```
┌─────────────────────────────────┐
│   Render Load Balancer         │
│   (HTTPS, Port 443)             │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│   pesaflow-app (Docker)         │
│   ┌──────────────────────────┐ │
│   │  Frontend (Next.js)      │ │
│   │  Port: 3001 (exposed)    │ │
│   └──────────┬───────────────┘ │
│              │                  │
│   ┌──────────▼───────────────┐ │
│   │  Backend (Rails)         │ │
│   │  Port: 3000 (internal)   │ │
│   └──────────────────────────┘ │
└─────────────────────────────────┘
         │              │
         ▼              ▼
    PostgreSQL      Redis
```

### Separate Deployment

```
┌─────────────────────────────────┐
│   Render Load Balancer         │
└──────────┬──────────┬──────────┘
           │           │
           ▼           ▼
    Frontend      Backend
    (Next.js)     (Rails)
```

## Troubleshooting

### Service won't start

1. **Check logs:**
   ```bash
   render logs pesaflow-app  # or pesaflow-backend/pesaflow-frontend
   ```

2. **Common issues:**
   - Missing `RAILS_MASTER_KEY`
   - Database connection failed (check `DATABASE_URL`)
   - Redis connection failed (check `REDIS_URL`)
   - Port binding issues (check PORT environment variable)

### Frontend can't connect to backend (Combined Deployment)

1. **Check `BACKEND_INTERNAL_URL`:**
   - Should be `http://localhost:3000` for combined deployment
   - Both services run in the same container

2. **Check supervisord logs:**
   ```bash
   render shell pesaflow-app
   supervisorctl status
   ```

### Database migrations failed

1. **Run migrations manually:**
   ```bash
   render shell pesaflow-app  # or pesaflow-backend
   cd /rails
   bundle exec rails db:migrate
   ```

2. **Check database connection:**
   - Verify `DATABASE_URL` is set correctly
   - Check database service is running

### Sidekiq not processing jobs

1. **Check Sidekiq logs:**
   ```bash
   render logs pesaflow-sidekiq
   ```

2. **Verify Redis connection:**
   - Check `REDIS_URL` is set correctly
   - Verify Redis service is running

## Scaling

### Combined Deployment

- **Starter Plan**: Good for development/testing (512 MB RAM)
- **Standard Plan**: Recommended for production (2 GB RAM)
- **Pro Plan**: For high-traffic applications (4 GB RAM)

**Note:** Combined deployment requires more resources since both services run together.

### Separate Deployment

- Can scale backend and frontend independently
- Each service can be on different plans
- More flexible for high-traffic scenarios

## Cost Estimation

### Combined Deployment (Starter):
- PostgreSQL Starter: ~$7/month
- Redis Starter: ~$10/month
- Web Service Standard: ~$25/month (recommended for combined)
- Background Worker Starter: ~$7/month

**Total: ~$49/month**

### Separate Deployment (Starter):
- PostgreSQL Starter: ~$7/month
- Redis Starter: ~$10/month
- Backend Web Service Starter: ~$7/month
- Frontend Web Service Starter: ~$7/month
- Background Worker Starter: ~$7/month

**Total: ~$38/month** (but less resources per service)

## Security Considerations

1. **Environment Variables:**
   - Never commit secrets to git
   - Use Render's environment variable management
   - Rotate secrets regularly

2. **Database:**
   - Database is not publicly accessible
   - Use strong passwords
   - Enable SSL connections

3. **HTTPS:**
   - Render provides free SSL certificates
   - Always use HTTPS in production

4. **Rate Limiting:**
   - Already configured with rack-attack
   - Monitor rate limit logs

## Support

- Render Documentation: https://render.com/docs
- Render Support: support@render.com
- Render Community: https://community.render.com
