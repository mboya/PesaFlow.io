# Render Deployment Guide

This guide explains how to deploy PesaFlow.io to Render using Docker.

## Prerequisites

1. A Render account (sign up at https://render.com)
2. Your M-Pesa API credentials
3. SMTP credentials for sending emails
4. A domain name (optional, but recommended)

## Quick Start

### Option 1: Using Render Blueprint (Recommended)

1. **Push your code to GitHub/GitLab/Bitbucket**

2. **Connect your repository to Render:**
   - Go to Render Dashboard
   - Click "New +" → "Blueprint"
   - Connect your repository
   - Render will automatically detect `render.yaml` and create all services

3. **Configure Environment Variables:**
   - Go to each service's "Environment" tab
   - Set the required environment variables (see below)

### Option 2: Manual Setup

1. **Create PostgreSQL Database:**
   - New → PostgreSQL
   - Name: `pesaflow-database`
   - Plan: Starter (or higher)

2. **Create Redis Instance:**
   - New → Redis
   - Name: `pesaflow-redis`
   - Plan: Starter (or higher)

3. **Create Backend Web Service:**
   - New → Web Service
   - Connect your repository
   - Name: `pesaflow-backend`
   - Runtime: Docker
   - Dockerfile Path: `./backend/Dockerfile`
   - Docker Context: `./backend`
   - Build Command: (leave empty, Docker handles it)
   - Start Command: (leave empty, uses CMD from Dockerfile)

4. **Create Sidekiq Worker:**
   - New → Background Worker
   - Connect your repository
   - Name: `pesaflow-sidekiq`
   - Runtime: Docker
   - Dockerfile Path: `./backend/Dockerfile`
   - Docker Context: `./backend`
   - Start Command: `bundle exec sidekiq`

5. **Create Frontend Web Service:**
   - New → Web Service
   - Connect your repository
   - Name: `pesaflow-frontend`
   - Runtime: Docker
   - Dockerfile Path: `./frontend/Dockerfile`
   - Docker Context: `./frontend`
   - Build Command: (leave empty)
   - Start Command: (leave empty)

## Environment Variables

### Backend Service (`pesaflow-backend`)

#### Required Rails Variables:
- `RAILS_ENV`: `production`
- `RAILS_MASTER_KEY`: Copy from `backend/config/master.key` (or generate new one)
- `SECRET_KEY_BASE`: Auto-generated by Render (or set manually)
- `DATABASE_URL`: Auto-connected from PostgreSQL service
- `REDIS_URL`: Auto-connected from Redis service

#### M-Pesa Configuration:
- `MPESA_BASE_URL`: `https://api.safaricom.co.ke` (production) or `https://sandbox.safaricom.co.ke` (sandbox)
- `MPESA_CONSUMER_KEY`: Your M-Pesa Consumer Key
- `MPESA_CONSUMER_SECRET`: Your M-Pesa Consumer Secret
- `MPESA_BUSINESS_SHORT_CODE`: Your business short code
- `MPESA_PASSKEY`: Your M-Pesa passkey
- `MPESA_CALLBACK_URL`: `https://your-backend-url.onrender.com/webhooks/stk_push/callback`
- `APP_HOST`: Your backend URL (e.g., `pesaflow-backend.onrender.com`)

#### SMTP Configuration:
- `SMTP_HOST`: Your SMTP server (e.g., `smtp.sendgrid.net`, `smtp.mailgun.org`)
- `SMTP_PORT`: `587` (or `465` for SSL)
- `SMTP_USERNAME`: Your SMTP username
- `SMTP_PASSWORD`: Your SMTP password
- `SMTP_FROM_EMAIL`: Email address to send from (e.g., `noreply@yourdomain.com`)

### Sidekiq Worker (`pesaflow-sidekiq`)

All environment variables are automatically synced from the backend service. No additional configuration needed.

### Frontend Service (`pesaflow-frontend`)

- `NODE_ENV`: `production`
- `NEXT_PUBLIC_API_URL`: `https://your-backend-url.onrender.com/api/v1` (or use proxy)
- `BACKEND_INTERNAL_URL`: Auto-connected from backend service (for internal proxy)
- `NEXT_PUBLIC_WS_URL`: `wss://your-frontend-url.onrender.com/api/proxy/ws` (if using WebSockets)

## Post-Deployment Steps

### 1. Run Database Migrations

After the backend service is deployed:

```bash
# Using Render Shell
render shell pesaflow-backend

# Inside the shell
bundle exec rails db:migrate
bundle exec rails db:seed
```

### 2. Verify Services

1. **Backend Health Check:**
   - Visit: `https://your-backend-url.onrender.com/up`
   - Should return: `{"status":"ok"}`

2. **Frontend:**
   - Visit: `https://your-frontend-url.onrender.com`
   - Should show the landing page

3. **Database Connection:**
   - Check backend logs for any database connection errors

### 3. Configure Custom Domain (Optional)

1. In Render dashboard, go to your service
2. Click "Custom Domains"
3. Add your domain
4. Update DNS records as instructed
5. Update `APP_HOST` and callback URLs with your custom domain

## Service URLs

After deployment, Render will provide URLs like:
- Backend: `https://pesaflow-backend-xxxx.onrender.com`
- Frontend: `https://pesaflow-frontend-xxxx.onrender.com`
- Database: Internal (not publicly accessible)
- Redis: Internal (not publicly accessible)

## Troubleshooting

### Backend won't start

1. **Check logs:**
   ```bash
   render logs pesaflow-backend
   ```

2. **Common issues:**
   - Missing `RAILS_MASTER_KEY`
   - Database connection failed (check `DATABASE_URL`)
   - Redis connection failed (check `REDIS_URL`)

### Frontend can't connect to backend

1. **Check `NEXT_PUBLIC_API_URL`:**
   - Should point to your backend URL
   - Or use the proxy at `/api/proxy`

2. **Check CORS settings:**
   - Backend CORS should allow your frontend domain

### Database migrations failed

1. **Run migrations manually:**
   ```bash
   render shell pesaflow-backend
   bundle exec rails db:migrate
   ```

2. **Check database connection:**
   - Verify `DATABASE_URL` is set correctly
   - Check database service is running

### Sidekiq not processing jobs

1. **Check Sidekiq logs:**
   ```bash
   render logs pesaflow-sidekiq
   ```

2. **Verify Redis connection:**
   - Check `REDIS_URL` is set correctly
   - Verify Redis service is running

## Scaling

### Upgrade Plans

- **Starter**: Good for development/testing
- **Standard**: Recommended for production (better performance)
- **Pro**: For high-traffic applications

### Auto-scaling

Render supports auto-scaling based on:
- CPU usage
- Memory usage
- Request count

Configure in service settings → "Scaling"

## Monitoring

### Health Checks

- Backend: `/up` endpoint
- Frontend: Root path `/`

### Logs

View logs in Render dashboard or via CLI:
```bash
render logs pesaflow-backend
render logs pesaflow-frontend
render logs pesaflow-sidekiq
```

## Cost Estimation

- PostgreSQL Starter: ~$7/month
- Redis Starter: ~$10/month
- Web Service Starter: ~$7/month (per service)
- Background Worker Starter: ~$7/month

**Total (Starter plan): ~$38/month**

Upgrade to Standard/Pro plans for better performance and higher limits.

## Security Considerations

1. **Environment Variables:**
   - Never commit secrets to git
   - Use Render's environment variable management
   - Rotate secrets regularly

2. **Database:**
   - Database is not publicly accessible
   - Use strong passwords
   - Enable SSL connections

3. **HTTPS:**
   - Render provides free SSL certificates
   - Always use HTTPS in production

4. **Rate Limiting:**
   - Already configured with rack-attack
   - Monitor rate limit logs

## Support

- Render Documentation: https://render.com/docs
- Render Support: support@render.com
- Render Community: https://community.render.com
