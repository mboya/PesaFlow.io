# Render Deployment Guide

This guide explains how to deploy PesaFlow.io to Render using Docker.

## Deployment Options

### Option 1: Combined Deployment (Recommended for Simplicity)

Deploy both backend and frontend together in a single service. This is simpler and more cost-effective.

**File:** Use `render-combined.yaml`

**Benefits:**
- Single service to manage
- Lower cost (one web service instead of two)
- Simpler configuration
- Both services deploy together automatically

**Trade-offs:**
- Cannot scale backend and frontend independently
- Requires more resources (standard plan recommended)

### Option 2: Separate Deployment

Deploy backend and frontend as separate services for independent scaling.

**File:** Use `render.yaml`

**Benefits:**
- Can scale backend and frontend independently
- Better resource isolation
- More flexible for high-traffic scenarios

**Trade-offs:**
- Higher cost (two web services)
- More complex configuration
- Need to manage service dependencies

## Quick Start

### Using Render Blueprint (Recommended)

1. **Push your code to GitHub/GitLab/Bitbucket**

2. **Connect your repository to Render:**
   - Go to Render Dashboard
   - Click "New +" → "Blueprint"
   - Connect your repository
   - Choose your deployment file:
     - `render-combined.yaml` for combined deployment
     - `render.yaml` for separate deployment
   - Render will automatically create all services

3. **Configure Environment Variables:**
   - Go to the service's "Environment" tab
   - Set the required environment variables (see below)

### Manual Setup

See the detailed sections below for manual setup instructions.

## Database Setup with Neon

This deployment uses [Neon](https://neon.com/) as the database provider instead of Render's managed PostgreSQL. Neon is a serverless Postgres database that offers features like instant provisioning, autoscaling, and branching.

### Setting up Neon Database

1. **Create a Neon Account:**
   - Go to [https://neon.com/](https://neon.com/)
   - Sign up for a free account

2. **Create a New Project:**
   - In the Neon dashboard, click "New Project"
   - Choose a project name (e.g., "pesaflow-production")
   - Select a region close to your Render deployment
   - Click "Create Project"

3. **Get Your Connection String:**
   - After creating the project, Neon will provide a connection string
   - It will look like: `postgresql://user:password@ep-xxxxx.region.aws.neon.tech/dbname?sslmode=require`
   - You can find it in the "Connection Details" section of your project
   - **Important:** Use the connection string that includes `?sslmode=require` for secure connections

4. **Configure Database in Render:**
   - In your Render service's "Environment" tab
   - Set `DATABASE_URL` to your Neon connection string
   - Make sure to set this for both:
     - `pesaflow-backend` service (or `pesaflow-app` for combined deployment)
     - `pesaflow-sidekiq` worker service

5. **Run Database Migrations:**
   - After deployment, connect to your service shell:
     ```bash
     render shell pesaflow-backend  # or pesaflow-app for combined
     ```
   - Run migrations:
     ```bash
     cd /rails
     bundle exec rails db:migrate
     bundle exec rails db:seed  # if you have seed data
     ```

### Neon Benefits

- **Serverless:** Scales automatically with your traffic
- **Instant Provisioning:** Database ready in seconds
- **Branching:** Create database branches for development/testing
- **Scale to Zero:** Saves costs when idle (on free tier)
- **Point-in-time Recovery:** Up to 30 days of backup history
- **Free Tier:** Generous free tier for development

### Neon Connection String Format

The connection string should be in this format:
```
postgresql://username:password@hostname/database?sslmode=require
```

Make sure to:
- Include `?sslmode=require` for secure connections
- Use the connection string from your Neon project dashboard
- Keep it secure and never commit it to version control

## Environment Variables

### Combined Deployment (`render-combined.yaml`)

#### Main App Service (`pesaflow-app`):

**Required Rails Variables:**
- `RAILS_ENV`: `production`
- `RAILS_MASTER_KEY`: Copy from `backend/config/master.key` (or generate new one)
- `SECRET_KEY_BASE`: Auto-generated by Render (or set manually)
- `DATABASE_URL`: **Set to your Neon database connection string** (see Database Setup section above)
- `REDIS_URL`: Auto-connected from Redis service

**M-Pesa Configuration:**
- `MPESA_BASE_URL`: `https://api.safaricom.co.ke` (production) or `https://sandbox.safaricom.co.ke` (sandbox)
- `MPESA_CONSUMER_KEY`: Your M-Pesa Consumer Key
- `MPESA_CONSUMER_SECRET`: Your M-Pesa Consumer Secret
- `MPESA_BUSINESS_SHORT_CODE`: Your business short code
- `MPESA_PASSKEY`: Your M-Pesa passkey
- `MPESA_CALLBACK_URL`: `https://your-app-url.onrender.com/webhooks/stk_push/callback`
- `APP_HOST`: Your app URL (e.g., `pesaflow-app.onrender.com`)

**SMTP Configuration:**
- `SMTP_HOST`: Your SMTP server (e.g., `smtp.sendgrid.net`, `smtp.mailgun.org`)
- `SMTP_PORT`: `587` (or `465` for SSL)
- `SMTP_USERNAME`: Your SMTP username
- `SMTP_PASSWORD`: Your SMTP password
- `SMTP_FROM_EMAIL`: Email address to send from (e.g., `noreply@yourdomain.com`)

**Frontend Configuration (Auto-set):**
- `NEXT_PUBLIC_API_URL`: Auto-set to `https://your-app-url.onrender.com/api/proxy`
- `BACKEND_INTERNAL_URL`: Auto-set to `http://localhost:3000` (internal)
- `NEXT_PUBLIC_WS_URL`: Auto-set to `wss://your-app-url.onrender.com/api/proxy/ws`
- `FRONTEND_URL`: Auto-set for CORS

### Separate Deployment (`render.yaml`)

**Backend Service (`pesaflow-backend`):**

**Required Rails Variables:**
- `RAILS_ENV`: `production`
- `RAILS_MASTER_KEY`: Copy from `backend/config/master.key` (or generate new one)
- `SECRET_KEY_BASE`: Auto-generated by Render (or set manually)
- `DATABASE_URL`: **Set to your Neon database connection string** (see Database Setup section above)
- `REDIS_URL`: Auto-connected from Redis service

**Sidekiq Worker (`pesaflow-sidekiq`):**

**Required Variables:**
- `RAILS_ENV`: `production`
- `RAILS_MASTER_KEY`: Same as backend service
- `SECRET_KEY_BASE`: Same as backend service (or set separately)
- `DATABASE_URL`: **Set to your Neon database connection string** (same as backend)
- `REDIS_URL`: Auto-connected from Redis service

**M-Pesa Configuration (for both backend and sidekiq):**
- `MPESA_BASE_URL`: `https://api.safaricom.co.ke` (production) or `https://sandbox.safaricom.co.ke` (sandbox)
- `MPESA_CONSUMER_KEY`: Your M-Pesa Consumer Key
- `MPESA_CONSUMER_SECRET`: Your M-Pesa Consumer Secret
- `MPESA_BUSINESS_SHORT_CODE`: Your business short code
- `MPESA_PASSKEY`: Your M-Pesa passkey
- `MPESA_CALLBACK_URL`: `https://your-backend-url.onrender.com/webhooks/stk_push/callback`
- `APP_HOST`: Your backend URL (e.g., `pesaflow-backend.onrender.com`)

**Frontend Service (`pesaflow-frontend`):**
- `NODE_ENV`: `production`
- `NEXT_PUBLIC_API_URL`: `https://your-backend-url.onrender.com/api`
- `BACKEND_INTERNAL_URL`: `http://pesaflow-backend:10000` (internal Render network)
- `NEXT_PUBLIC_WS_URL`: `wss://your-backend-url.onrender.com/cable`

## Post-Deployment Steps

### 1. Run Database Migrations

After the service is deployed and `DATABASE_URL` is configured with your Neon connection string:

```bash
# Using Render Shell
render shell pesaflow-app  # or pesaflow-backend for separate deployment

# Inside the shell
cd /rails
bundle exec rails db:migrate
bundle exec rails db:seed
```

**Note:** Make sure `DATABASE_URL` is set correctly before running migrations. You can verify the connection by running:
```bash
bundle exec rails db:version
```

### 2. Verify Services

1. **Backend Health Check:**
   - Visit: `https://your-app-url.onrender.com/up`
   - Should return: `{"status":"ok"}`

2. **Frontend:**
   - Visit: `https://your-app-url.onrender.com`
   - Should show the landing page

3. **Database Connection:**
   - Check service logs for any database connection errors

### 3. Configure Custom Domain (Optional)

1. In Render dashboard, go to your service
2. Click "Custom Domains"
3. Add your domain
4. Update DNS records as instructed
5. Update `APP_HOST` and callback URLs with your custom domain

## Service Architecture

### Combined Deployment

```
┌─────────────────────────────────┐
│   Render Load Balancer         │
│   (HTTPS, Port 443)             │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│   pesaflow-app (Docker)         │
│   ┌──────────────────────────┐ │
│   │  Frontend (Next.js)      │ │
│   │  Port: 3001 (exposed)    │ │
│   └──────────┬───────────────┘ │
│              │                  │
│   ┌──────────▼───────────────┐ │
│   │  Backend (Rails)         │ │
│   │  Port: 3000 (internal)   │ │
│   └──────────────────────────┘ │
└─────────────────────────────────┘
         │              │
         ▼              ▼
    PostgreSQL      Redis
```

### Separate Deployment

```
┌─────────────────────────────────┐
│   Render Load Balancer         │
└──────────┬──────────┬──────────┘
           │           │
           ▼           ▼
    Frontend      Backend
    (Next.js)     (Rails)
```

## Troubleshooting

### Service won't start

1. **Check logs:**
   ```bash
   render logs pesaflow-app  # or pesaflow-backend/pesaflow-frontend
   ```

2. **Common issues:**
   - Missing `RAILS_MASTER_KEY`
   - Database connection failed (check `DATABASE_URL` is set to your Neon connection string)
   - Redis connection failed (check `REDIS_URL`)
   - Port binding issues (check PORT environment variable)
   - SSL connection issues with Neon (ensure connection string includes `?sslmode=require`)

### Frontend can't connect to backend (Combined Deployment)

1. **Check `BACKEND_INTERNAL_URL`:**
   - Should be `http://localhost:3000` for combined deployment
   - Both services run in the same container

2. **Check supervisord logs:**
   ```bash
   render shell pesaflow-app
   supervisorctl status
   ```

### Database migrations failed

1. **Run migrations manually:**
   ```bash
   render shell pesaflow-app  # or pesaflow-backend
   cd /rails
   bundle exec rails db:migrate
   ```

2. **Check database connection:**
   - Verify `DATABASE_URL` is set correctly to your Neon connection string
   - Ensure the connection string includes `?sslmode=require`
   - Check Neon dashboard to ensure your database is active
   - Verify your Neon project is in the same region as your Render deployment for better performance

### Sidekiq not processing jobs

1. **Check Sidekiq logs:**
   ```bash
   render logs pesaflow-sidekiq
   ```

2. **Verify Redis connection:**
   - Check `REDIS_URL` is set correctly
   - Verify Redis service is running

## Scaling

### Combined Deployment

- **Starter Plan**: Good for development/testing (512 MB RAM)
- **Standard Plan**: Recommended for production (2 GB RAM)
- **Pro Plan**: For high-traffic applications (4 GB RAM)

**Note:** Combined deployment requires more resources since both services run together.

### Separate Deployment

- Can scale backend and frontend independently
- Each service can be on different plans
- More flexible for high-traffic scenarios

## Cost Estimation

### Combined Deployment (Starter):
- **Neon Database:** Free tier available (or paid plans starting ~$19/month)
- Redis Starter: ~$10/month
- Web Service Standard: ~$25/month (recommended for combined)
- Background Worker Starter: ~$7/month

**Total: ~$42/month** (with Neon free tier) or **~$61/month** (with Neon paid plan)

### Separate Deployment (Starter):
- **Neon Database:** Free tier available (or paid plans starting ~$19/month)
- Redis Starter: ~$10/month
- Backend Web Service Starter: ~$7/month
- Frontend Web Service Starter: ~$7/month
- Background Worker Starter: ~$7/month

**Total: ~$31/month** (with Neon free tier) or **~$50/month** (with Neon paid plan)

**Note:** Neon's free tier includes:
- 0.5 GB storage
- Shared CPU
- 192 MB RAM
- Perfect for development and small production workloads

## Security Considerations

1. **Environment Variables:**
   - Never commit secrets to git
   - Use Render's environment variable management
   - Rotate secrets regularly

2. **Database:**
   - Neon databases are secured with SSL by default
   - Always use connection strings with `?sslmode=require`
   - Use strong passwords (Neon generates secure passwords automatically)
   - Never commit connection strings to version control
   - Use Neon's IP allowlist feature if you need additional security

3. **HTTPS:**
   - Render provides free SSL certificates
   - Always use HTTPS in production

4. **Rate Limiting:**
   - Already configured with rack-attack
   - Monitor rate limit logs

## Support

- Render Documentation: https://render.com/docs
- Render Support: support@render.com
- Render Community: https://community.render.com
