<!DOCTYPE html>
<html>
  <head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
  </head>
  <body>
    <h1>Invoice <%= @invoice.invoice_number %></h1>
    
    <p>Dear <%= @customer.name %>,</p>
    
    <p>Please find your invoice details below.</p>
    
    <h2>Invoice Information</h2>
    <ul>
      <li><strong>Invoice Number:</strong> <%= @invoice.invoice_number %></li>
      <li><strong>Subscription:</strong> <%= @subscription.reference_number %></li>
      <li><strong>Service:</strong> <%= @subscription.plan_name %></li>
      <li><strong>Amount:</strong> KES <%= number_with_precision(@invoice.amount, precision: 2) %></li>
      <li><strong>Status:</strong> <%= @invoice.status.capitalize %></li>
      <li><strong>Issue Date:</strong> <%= @invoice.attempted_at&.strftime('%B %d, %Y') || Date.current.strftime('%B %d, %Y') %></li>
      <li><strong>Due Date:</strong> <%= @subscription.current_period_end&.strftime('%B %d, %Y') || (Date.current + 30.days).strftime('%B %d, %Y') %></li>
      <% if @invoice.status == 'completed' && @invoice.attempted_at.present? %>
        <li><strong>Paid Date:</strong> <%= @invoice.attempted_at.strftime('%B %d, %Y at %I:%M %p') %></li>
      <% end %>
      <% if @invoice.mpesa_receipt_number.present? %>
        <li><strong>M-Pesa Receipt:</strong> <%= @invoice.mpesa_receipt_number %></li>
      <% end %>
    </ul>
    
    <h2>Details</h2>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #f5f5f5;">
          <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Description</th>
          <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <%= @subscription.plan_name %>
            <% if @subscription.current_period_start && @subscription.current_period_end %>
              <br><small>Period: <%= @subscription.current_period_start.strftime('%b %d') %> - <%= @subscription.current_period_end.strftime('%b %d, %Y') %></small>
            <% end %>
          </td>
          <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">KES <%= number_with_precision(@invoice.amount, precision: 2) %></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td style="padding: 8px; text-align: right; border: 1px solid #ddd;"><strong>Total:</strong></td>
          <td style="padding: 8px; text-align: right; border: 1px solid #ddd;"><strong>KES <%= number_with_precision(@invoice.amount, precision: 2) %></strong></td>
        </tr>
      </tfoot>
    </table>
    
    <% if @invoice.status == 'pending' %>
      <p><strong>Payment is due by <%= @subscription.current_period_end&.strftime('%B %d, %Y') || (Date.current + 30.days).strftime('%B %d, %Y') %>.</strong></p>
      <p>You can make a payment through your dashboard or by using M-Pesa.</p>
    <% end %>
    
    <p>If you have any questions about this invoice, please contact our support team.</p>
    
    <p>Thank you for your business!</p>
  </body>
</html>
